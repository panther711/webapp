<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tinode example: chat web application in react.js</title>
    <!-- Customized Bootstrap style (material design). -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <!-- Styles for local elements -->
    <link rel="stylesheet" href="css/base.css" />
    <!-- ReactJs scripts -->
    <script src="https://fb.me/react-0.14.5.js"></script>
    <script src="https://fb.me/react-dom-0.14.5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <!-- Some scripts to make bootstrap more dynamic -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </head>
  </head>
  <body>
    <div id="mountPoint"></div>
    <script type="text/babel">
    function shortDateFormat(then) {
	    var now = new Date();
      if (then.getFullYear() == now.getFullYear()) {
  	    if (then.getMonth() == now.getMonth() && then.getDate() == now.getDate()) {
    	    return then.toLocaleTimeString(undefined, {hour12: false, hour: '2-digit', minute: '2-digit'});
        } else {
    	    return then.toLocaleDateString(undefined,
            {hour12: false, month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
        }
      }
      return then.toLocaleDateString(undefined,
        {hour12: false, year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
    }

    /* BEGIN Login */
    var LoginNavbar = React.createClass({
      render: function() {
        return (
          <nav className="navbar navbar-inverse">
            <div className="container-fluid">
              <div className="navbar-header">
                <a className="navbar-brand" href="#">Tinode Demo Chat</a>
              </div>
              <div>
                <ul className="nav navbar-nav navbar-right">
                  <li className="dropdown">
                    <a href="#" className="dropdown-toggle" data-toggle="dropdown" role="button"
                      aria-haspopup="true" aria-expanded="false">
                      <big><span className="glyphicon glyphicon-option-vertical"></span></big>
                    </a>
                    <ul className="dropdown-menu">
                      <li><a href="#"><span className="glyphicon glyphicon-user"></span> Sign Up</a></li>
                      <li><a href="#"><span className="glyphicon glyphicon-cog"></span> Settings</a></li>
                      <li><a href="https://github.com/tinode/chat/"><span
                        className="glyphicon glyphicon-info-sign"></span> About</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        );
      }
    })

    var LoginForm = React.createClass({
      getInitialState: function() {
        return {login: '', password: ''};
      },
      handleLoginChange: function(e) {
        this.setState({login: e.target.value});
      },
      handlePasswordChange: function(e) {
        this.setState({password: e.target.value});
      },
      handleSubmit: function(e) {
        e.preventDefault();
        this.props.onLogin(true);
      },
      render: function() {
        return (
          <div className="container-fluid">
            <form className="form-signin" onSubmit={this.handleSubmit}>
              <label htmlFor="inputLogin" className="sr-only">Login</label>
              <input type="text" id="inputLogin" className="form-control"
                placeholder="Login (alice, bob, carol, dave, frank)"
                value={this.state.login}
                onChange={this.handleLoginChange}
                required autofocus />
              <label htmlFor="inputPassword" className="sr-only">Password</label>
              <input type="password" id="inputPassword" className="form-control"
                placeholder="Password (alice123, bob123, ...)"
                value={this.state.password}
                onChange={this.handlePasswordChange}
                required />
              <br />
              <button className="btn btn-lg btn-primary btn-block" type="submit">Sign in</button>
            </form>
          </div>
        );
      }
    })

    var LoginView = React.createClass({
      render: function() {
        return (
          <div>
            <LoginNavbar />
            <LoginForm onLogin={this.props.onLogin} />
          </div>
        );
      }
    })
    /* END Login */

    /* BEGIN Contact list (list of topics) */

    /*Contacts caption */
    var CurrentUser = React.createClass({
      render: function() {
        return (
          <nav id="main-navbar" className="navbar navbar-inverse">
            <div className="container-fluid">
              <div className="navbar-header">
                <a href="#" className="pull-left"><img id="self-avatar" className="avatar" alt="avatar"
                  src="avatar.svg" /></a>
                <span className="navbar-brand" href="#">Alice Johnson</span>
              </div>
              <div>
                <ul className="nav navbar-nav navbar-right">
                  <li><a href="#"><big><span className="glyphicon glyphicon-cog"></span></big></a></li>
                </ul>
              </div>
            </div>
          </nav>
        );
      }
    });

    /* A form for initiating a new topic */
    var NewTopic = React.createClass({
      render: function() {
        return (
          <div className="input-group">
            <label htmlFor="addTopic" className="sr-only">Add user or topic</label>
            <input id="addTopic" className="form-control" type="text" placeholder="Add topic" />
            <span className="input-group-btn"><button className="btn btn-default" type="button">
              <i className="glyphicon glyphicon-plus-sign"></i>
            </button></span>
          </div>
        );
      }
    });

    var contactsData = [
      {id: "usrBOB", public: "Bob Smith", comment: "This is another comment", online: {now: true}, unread: 0},
      {id: "usrCAROL", public: "Carol Xmas", comment: "No comments", online: {now: false, when: "1 hour ago"}, unread: 2},
      {id: "usrDAVE", public: "Dave Goliaphsson", comment: "This is a comment", online: {now: false, when: "30 min ago"}, unread: 0}
    ];

    /* A single topic */
    var Contact = React.createClass({
        handleClick: function() {
          this.props.onSelected(this.props.public);
        },
        render: function() {
          return (
            <li className="media contact" onClick={this.handleClick}>
              <a href="#" className="pull-left"><img src="avatar.svg" className="avatar img-circle" alt="" /></a>
              <div className="media-body">
                <Contact.Online when={this.props.when} now={this.props.now} />
                <strong>{this.props.public}</strong> <Contact.Unread count={this.props.unread} />
                <p>{this.props.comment}</p>
              </div>
            </li>
          );
        }
    });

    /* The counter of unread messages in the topic */
    Contact.Unread = React.createClass({
        render: function() {
          var showUnreadBadge = null;
          if (this.props.count > 0) {
            showUnreadBadge = <span className="label label-primary label-as-badge">{this.props.count}</span>;
          }
          return (
            <span>{showUnreadBadge}</span>
          );
        }
    })

    /* Online indicator */
    Contact.Online = React.createClass({
        render: function() {
          var lastOnline = '';
          if (!this.props.online && this.props.when) {
            lastOnline = this.props.when;
          } else {
            lastOnline = 'online now';
          }

          return (
            <span className="text-muted pull-right">
              <span className={this.props.now ? "online" : "offline"}>&#x25cf;</span> <small className="text-muted">&nbsp;{lastOnline}</small>
            </span>
          );
        }
    })

    /* List of comtacts/topics */
    var ContactList = React.createClass({
      getInitialState: function() {
        return {selected: false};
      },
      onSelectionChange: function(sel) {
        this.props.onTopicSelected(sel);
      },
      render: function() {
        var contactNodes = this.props.data.map(function(c) {
          return (
            <Contact public={c.public} comment={c.comment}
              unread={c.unread}
              when={c.online.when} now={c.online.now}
              onSelected={this.onSelectionChange} key={c.id} />
          );
        }, this);
        return (
          <div className="contactList">
            <ul className="media-list">
              {contactNodes}
            </ul>
          </div>
        );
      }
    });

    /* The panel to hold all contacts-related stuff together */
    var ContactsView = React.createClass({
      getInitialState: function() {
        return {contacts: []};
      },
      componentDidMount: function() {
        this.setState({contacts: contactsData});
      },
      render: function() {
        return (
          <div className="contactBox">
            <CurrentUser />
            <div className="container-fluid">
            <NewTopic />
            <ContactList data={this.state.contacts}
              onTopicSelected={this.props.onTopicSelected} />
            </div>
          </div>
        );
      }
    });
    /* END Contact list */

    /* BEGIN Conversation panel */
    var messagesList = [
      {
        id: 1, content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam sit amet tellus interdum. \
Integer sodales accumsan sem, ut malesuada velit egestas vel. Aenean consequat consectetur justo eget venenatis. Morbi \
eleifend fringilla urna euismod tristique. Nullam at magna vel mauris rutrum finibus. Duis eu dignissim magna. Donec \
        lobortis suscipit vulputate. Cras luctus elit ex, vitae lobortis magna lobortis bibendum.",
        timestamp: new Date(2015, 11, 31, 22, 23, 24, 567), response: false
      },
      {
        id: 2, content: "Duis porttitor est nec diam lobortis, non aliquam risus aliquam. \
Nulla vitae est aliquam, egestas nunc dapibus, dapibus risus.\
Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. \
Nullam vitae condimentum lectus, quis maximus elit.\
\
Nunc ac nisi risus. Integer eget augue vel risus commodo blandit. Nulla faucibus convallis neque sed eleifend. Vestibulum\
dignissim a diam a hendrerit. Nulla vel est ut quam rhoncus pulvinar. In hac habitasse platea dictumst.",
        timestamp: new Date(2016, 0, 1, 2, 3, 4, 567),
        response: true
      },
      {id: 3, content: "Ooga chaka ooga ooga!", timestamp: new Date(2016, 0, 2, 16, 17, 18, 567), response: false},
      {id: 4, content: "Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. \
      Nullam vitae condimentum lectus, quis maximus elit.", timestamp: new Date(2016, 0, 3, 1, 2, 3, 567), response: true},
      {id: 5, content: "Integer sodales accumsan sem, ut malesuada velit egestas vel. Aenean consequat consectetur justo eget venenatis.",
        timestamp: new Date(2016, 0, 3, 4, 5, 6, 567), response: true},
      {id: 6, content: "No way.", timestamp: new Date(2016, 0, 3, 15, 16, 17, 567), response: false},
      {id: 7, content: "OK!", timestamp: new Date(2016, 0, 3, 18, 19, 20, 567), response: true}
    ];

    var Message = React.createClass({
      getInitialState: function() {
        return {received: 0};
      },
      render: function() {
        var timestamp = shortDateFormat(this.props.timestamp);
        return (
          <li className={this.props.response ? 'chatBox-inverted' : null}>
            <div className="chatBox-panel">
              <div className="chatBox-body">
                <p>{this.props.content}
                  <span className="pull-right timestamp">
                    <small className="text-muted">{timestamp}</small> <Message.ReceivedMarker />
                  </span>
                </p>
              </div>
            </div>
          </li>
        );
      }
    });

    /* Received/read indicator */
    Message.ReceivedMarker = React.createClass({
      getInitialState: function() {
        return {received: 0};
      },
      render: function() {
        var checkMark = null;
        if (this.state.received > 0) {
          checkMark = '&#x2714;';
          if (this.state.received > 1) {
            checkMark += <span style="margin-left:-0.5em;">&#x2714;</span>;
          }
        }
        return (
          <span>{checkMark}</span>
        );
      }
    });

    /* Send message form */
    Message.Send = React.createClass({
      render: function() {
        return (
          <div className="input-group">
            <label htmlFor="sendMessage" className="sr-only">Add topic</label>
            <input id="sendMessage" className="form-control" type="text" placeholder="New message" />
            <span className= "input-group-btn">
              <button className= "btn btn-default" type = "button">
                <i className="glyphicon glyphicon-send"></i>
              </button>
            </span>
          </div>
        );
      }
    });

    /* This is just a static page to show when no conversation is selected */
    var DummyMessagesView = React.createClass({
      render: function() {
        return (
          <div className="panel panel-default fullHeight">
          <div className="panel-body text-center center-block fullHeight" id="dummyView">
            <div><img id="logo" alt="logo" src="group.svg" />
            <h3>Tinode Demo Chat</h3></div>
          </div>
          </div>
        );
      }
    });

    var MessagesView = React.createClass({
      getInitialState: function() {
        return {messages: []};
      },
      componentDidMount: function() {
        this.setState({messages: messagesList});
      },
      render: function() {
        var messageNodes = this.state.messages.map(function(msg) {
          return (
            <Message content={msg.content} timestamp={msg.timestamp} response={msg.response} key={msg.id} />
          );
        });
        return (
          <div className="panel panel-default fullViewPort" id="messagesPanel">
            <div className="panel-heading" id="chatTitle">
              <h3 className="panel-title">{this.props.topic}</h3>
            </div>
            <div className="panel-body" id="messagesView">
              <ul className="chatBox">
                {messageNodes}
              </ul>
            </div>
            <div className="panel-footer" id="sendMessagePanel">
              <Message.Send />
            </div>
          </div>
        );
      }
    });
    /* END Conversation panel */


    var AppView = React.createClass({
      getInitialState: function() {
        return {loggedIn: false, selTopic: ''};
      },
      handleLogin: function(ok) {
        this.setState({loggedIn: ok});
      },
      handleTopicSelected: function(topic) {
        this.setState({selTopic: topic});
      },
      render: function() {
        return (
          <div className="fullScreen">

          <div id="sidebar-wrapper">
            <div className="sidebar-nav">
              {this.state.loggedIn ?
                <ContactsView data={contactsData}
                  onTopicSelected={this.handleTopicSelected} /> :
                <LoginView onLogin={this.handleLogin} />}
            </div>
          </div>

          <div id="page-content-wrapper">
            <div className="container-fluid fullHeight">
              <div className="row fullHeight">
                <div className="col-lg-12 fullHeight">
                  {this.state.selTopic ?
                    <MessagesView topic={this.state.selTopic} /> :
                    <DummyMessagesView />}
                </div>
              </div>
            </div>
          </div>

          </div>
        );
      }
    })

    ReactDOM.render(
      <AppView />,
      document.getElementById('mountPoint')
    );
    </script>

  </body>
</html>
