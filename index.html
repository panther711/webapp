<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tinode example: chat web application in react.js</title>
    <link rel="shortcut icon" href="img/logo32x32.png" />
    <!-- Google's Roboto font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,700&subset=latin,cyrillic"
      rel="stylesheet" type="text/css" />
    <!-- Google's material design icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <!-- Styles for local elements -->
    <link rel="stylesheet" href="css/base.css" />
    <!-- ReactJs scripts -->
    <script src="https://fb.me/react-0.14.7.js"></script>
    <script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="tinode.js"></script>
  </head>
  <body>
    <div id="mountPoint"></div>
    <script type="text/babel">
    // Name of this application, used in the User-Agent
    var APP_NAME = "TinodeReact/0.6";

    // Host name and port to connect to
    var HOST = "api.tinode.co";
    // var HOST = "localhost:6060";

    // API key. Use https://github.com/tinode/chat/tree/master/keygen to generate your own
    var API_KEY = "AQEAAAABAAD_rAp4DJh05a1HAwFT3A6K";

    // Minimum time between two keypress notifications, milliseconds.
    var KEYPRESS_DELAY = 5*1000;

    // Delay before sending a {note} for reciving a message, milliseconds.
    var RECEIVED_DELAY = 500;

    // Delay before sending a read notification, milliseconds.
    var READ_DELAY = 1000;

    // Mediaquery breakpoint between desktop and mobile, in px. Should match the value
    // in @meadia (max-size: 640px) in base.css
    var MEDIA_BREAKPOINT = 640;

    // Short representation of time in the past.
    function shortDateFormat(then) {
	    var now = new Date();
      if (then.getFullYear() == now.getFullYear()) {
  	    if (then.getMonth() == now.getMonth() && then.getDate() == now.getDate()) {
    	    return then.toLocaleTimeString(undefined, {hour12: false, hour: '2-digit', minute: '2-digit'});
        } else {
    	    return then.toLocaleDateString(undefined,
            {hour12: false, month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
        }
      }
      return then.toLocaleDateString(undefined,
        {hour12: false, year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
    }

    // Make a data URL from public.photo
    function makeImageUrl(photo) {
      return photo ? 'data:image/' + photo.type + ';base64,' + photo.data : null;
    }

    /* BEGIN Login: a login form */
    var LoginView = React.createClass({
      getInitialState: function() {
        return {
          login: '',
          password: '',
          errorCleared: false
        };
      },
      handleLoginChange: function(e) {
        if (!this.state.errorCleared) {
          this.props.onClearError();
          this.setState({errorCleared: true});
        }
        this.setState({login: e.target.value});
      },
      handlePasswordChange: function(e) {
        if (!this.state.errorCleared) {
          this.props.onClearError();
          this.setState({errorCleared: true});
        }
        this.setState({password: e.target.value});
      },
      handleSubmit: function(e) {
        e.preventDefault();
        this.setState({errorCleared: false});
        this.props.onLogin(this.state.login.trim(), this.state.password.trim());
      },
      render: function() {
        var submitClasses = "blue";
        if (this.props.disabled) {
          submitClasses += " disabled";
        }
        return (
          <div>
            <form id="login-form" onSubmit={this.handleSubmit}>
              <input type="text" id="inputLogin"
                placeholder="Login (alice, bob, carol, dave, frank)"
                value={this.state.login}
                onChange={this.handleLoginChange}
                required autofocus />
              <input type="password" id="inputPassword"
                placeholder="Password (alice123, bob123, ...)"
                value={this.state.password}
                onChange={this.handlePasswordChange}
                required />
              <div className="dialog-buttons">
                <button className={submitClasses} type="submit">Sign in</button>
              </div>
            </form>
          </div>
        );
      }
    })
    /* END Login */

    /* BEGIN Account registration */

    var CreateAccountView = React.createClass({
      getInitialState: function() {
        return {
          login: '',
          password: '',
          password2: '',
          fn: '', // full/formatted name
          imageDataUrl: null,
          errorCleared: false
        };
      },
      handleLoginChange: function(e) {
        this.setState({login: e.target.value});
      },
      handlePasswordChange: function(e) {
        this.setState({password: e.target.value});
      },
      handlePassword2Change: function(e) {
        this.setState({password2: e.target.value});
      },
      handleFnChange: function(e) {
        this.setState({fn: e.target.value});
      },
      handleImageChanged: function(img) {
        this.setState({imageDataUrl: img});
      },
      handleSubmit: function(e) {
        e.preventDefault();
        if (this.state.password.trim() != this.state.password2.trim()) {
          // FIXME(gene): report an error here.
        } else {
          this.setState({errorCleared: false});
          var vcard = null;
          if (this.state.name.trim() || this.state.imageDataUrl) {
            vcard = {
              fn: this.state.name.trim(),
            };
            if (this.state.imageDataUrl) {
              dataStart = this.state.imageDataUrl.indexOf(",");
              vcard.photo = {
                data: this.state.imageDataUrl.substring(dataStart),
                type: "jpg"
              };
            }
          }
          this.props.onCreateAccount(this.state.login.trim(), this.state.password.trim(), vcard);
        }
      },
      render: function() {
        var submitClasses = "blue";
        if (this.props.disabled) {
          submitClasses += " disabled";
        }
        return (
          <div>
            <form id="signup-form" onSubmit={this.handleSubmit} onCancel={this.props.onCancel}>
              <div id="signup-form-one">
                <div>
                  <input type="text" placeholder="Login"
                    value={this.state.login} onChange={this.handleLoginChange} required autofocus />
                  <input type="password" placeholder="Password"
                    value={this.state.password} onChange={this.handlePasswordChange} required />
                  <input type="password" placeholder="Repeat password"
                    value={this.state.password2} onChange={this.handlePassword2Change} required />
                </div>
                <CreateAccountView.AvatarUpload onImageChanged={this.handleImageChanged} />
              </div>
              <input type="text" placeholder="Full name, e.g. John Doe"
                value={this.state.fn} onChange={this.handleFnChange} />
              <div className="dialog-buttons">
                <button className={submitClasses} type="submit">Sign up</button>
              </div>
            </form>
          </div>
        );
      }
    });

    CreateAccountView.AvatarUpload = React.createClass({
      getInitialState: function() {
        return {
          dataUrl: null
        };
      },
      handleFileUpload(e) {
        var instance = this;
        var img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
          var canvas = document.createElement('CANVAS');
          canvas.width = canvas.height = 64;
          var ctx = canvas.getContext('2d');
          var sx = 0, sy = 0, size;
          if (this.height > this.width) {
            size = this.width;
            sy = (this.height - size) / 2;
          } else {
        	  size = this.height;
            sx = (this.width - size) / 2;
          }
 				  ctx.imageSmoothingEnabled = true;
          ctx.drawImage(this, sx, sy, size, size, 0, 0, 64, 64);
          instance.setState({dataUrl: canvas.toDataURL("image/jpg")});
          canvas = null;
        };
        img.src = URL.createObjectURL(e.target.files[0]);
      },
      render: function() {
        return (
          <div className="avatar-upload">
            {this.state.dataUrl ?
              <img src={this.state.dataUrl} className="preview" /> :
              <div className="blank">64&times;64</div>}
            <input type="file" id="file-input-avatar" className="inputfile hidden"
              accept="image/*" onChange={this.handleFileUpload} />
            <label htmlFor="file-input-avatar" className="round">
              <i className="material-icons">file_upload</i>
            </label>
          </div>
        );
      }
    });
    /* END Account registration */

    /* BEGIN Tinode config panel */
    var SettingsView = React.createClass({
      getInitialState: function() {
        return {
          hostName: HOST,
        };
      },
      handleSubmit: function(e) {
        e.preventDefault();
      },
      handleHostNameChange: function(e) {
        this.setState({hostName: e.target.value});
      },
      render: function() {
        return (
          <form id="settings-form" onSubmit={this.handleSubmit}>
            <p>This form does not do anything yet</p>
            <label htmlFor="host-name">Host:</label>
            <input type="text" id="host-name" placeholder="api.tinode.co"
              value={this.state.hostName} onChange={this.handleHostNameChange} required autofocus />
            <p>Wire transport:</p>
            <ul>
              <li>
                <input type="radio" id="transport-default" name="transport-select" defaultChecked />
                <label htmlFor="transport-default">default</label>
              </li>
              <li>
                <input type="radio" id="transport-ws" name="transport-select" />
                <label htmlFor="transport-ws">websocket</label>
              </li>
              <li>
                <input type="radio" id="transport-lp" name="transport-select" />
                <label htmlFor="transport-lp">long polling</label>
              </li>
            </ul>
            <div className="dialog-buttons">
              <button type="submit" className="blue">Update</button>
            </div>
          </form>
        );
      }
    });
    /* END Tinode config panel */

    /* BEGIN Manage side panel - handle Login, Account Registration, and Contacts views */
    var SideNavbar = React.createClass({
      render: function() {
        var avatar = null;
        if (this.props.avatar === true) {
          avatar = <i id="self-avatar" className="material-icons">account_box</i>;
        } else if (this.props.avatar) {
          avatar = <img id="self-avatar" alt="avatar" src={this.props.avatar} />;
        }
        return (
            <div id="side-caption-panel">
              {avatar}
              <div id="sidepanel-title" className="panel-title">{this.props.title}</div>
              {this.props.state === 'login' ?
                  <SideNavbar.MenuStart onSignUp={this.props.onSignUp} onSettings={this.props.onSettings} /> :
                    this.props.state === 'settings' ?
                    <SideNavbar.MenuCancel onCancel={this.props.onCancel} /> :
                    this.props.state === 'edit-account' ?
                    <SideNavbar.MenuCancel onCancel={this.props.onCancel} /> :
                    this.props.state === 'register' ?
                    <SideNavbar.MenuCancel onCancel={this.props.onCancel} /> :
                    this.props.state === 'contacts' ?
                    <SideNavbar.MenuSettings onSettings={this.props.onSettings} /> : null}
            </div>
        );
      }
    })

    SideNavbar.MenuStart = React.createClass({
      render: function() {
        return (
            <div>
              <a href="#" onClick={this.props.onSignUp}><i className="material-icons">person_add</i></a>
              &nbsp;
              <a href="#" onClick={this.props.onSettings}><i className="material-icons">settings</i></a>
            </div>
        );
      }
    });

    SideNavbar.MenuCancel = React.createClass({
      render: function() {
        return (
          <a href="#" onClick={this.props.onCancel}><i className="material-icons">close</i></a>
        );
      }
    })

    SideNavbar.MenuSettings = React.createClass({
      render: function() {
        return (
          <a href="#" onClick={this.props.onSettings}><i className="material-icons">settings</i></a>
        );
      }
    })

    var SidepanelView = React.createClass({
      getInitialState: function() {
        return {
          showErrorText: true,
        };
      },
      handleClearErrorText: function() {
        this.setState({showErrorText: false});
      },
      handleLoginRequested: function(login, password) {
        this.props.onLoginRequest(login, password);
        this.setState({showErrorText: true});
      },
      render: function() {
        var title = null;
        var avatar = false;
        switch (this.props.state) {
          case 'login':
            title = "Sign In"; break;
          case 'register':
            title = "Create Account"; break;
          case 'settings':
            title = "Settings"; break;
          case 'edit-account':
            title = "Edit Account"; break;
          case 'contacts':
            title = this.props.title;
            avatar = this.props.avatar;
          default:;
        };
        return (
          <div id="sidepanel" className={this.props.hideSelf ? 'nodisplay' : null}>
            <SideNavbar state={this.props.state}
              title={title} avatar={avatar}
              onSignUp={this.props.onSignUp}
              onSettings={this.props.onSettings}
              onCancel={this.props.onCancel} />

            <SidepanelView.ErrorPanel
              showError={this.state.showErrorText}
              errorText={this.props.errorText} />

            {this.props.state === 'login' ?
              <LoginView disabled={this.props.loginDisabled}
                onLogin={this.handleLoginRequested}
                onClearError={this.handleClearErrorText} /> :

              this.props.state === 'register' ?
              <CreateAccountView
                onCreateAccount={this.props.onCreateAccount}
                onCancel={this.props.onCancel} /> :

              this.props.state === 'settings' ?
              <SettingsView onCancel={this.props.onCancel} /> :

              this.props.state === 'edit-account' ?
              <EditAccountView onCancel={this.props.onCancel} /> :

              this.props.state === 'contacts' ?
              <ContactsView
                data={this.props.subscriptions}
                onTopicSelected={this.props.onTopicSelected}
                onNewTopic={this.props.onNewTopic} /> :
              null}
          </div>
        );
      }
    });

    SidepanelView.ErrorPanel = React.createClass({
      render: function() {
        var errorClass = null;
        var errorText = ' ';
        if (this.props.errorText && this.props.showError) {
          errorClass = "error-alert";
          errorText = this.props.errorText;
        }
        return (
          <div id="alert-box" className={errorClass}>{errorText}</div>
        );
      }
    });

    /* END Side panel */

    /* EditAccount parameters */
    var EditAccountView = React.createClass({
      render: function() {
        return (
          <form id="edit-account">
            <p>Not implemented</p>
          </form>
        );
      }
    });
    /* END EditAccount */

    /* BEGIN Contact list (list of topics) */

    /* A form for initiating a new topic
    var NewTopic = React.createClass({
      render: function() {
        return (
          <div className="input-group" id="newTopicInput">
            <label htmlFor="addTopic" className="sr-only">Add user or topic</label>
            <input id="addTopic" className="form-control" type="text" placeholder="Add topic" />
            <span className="input-group-btn"><button className="btn btn-default" type="button">
              <i className="material-icons">add</i>
            </button></span>
          </div>
        );
      }
    });
    */

    /* A single topic */
    var Contact = React.createClass({
        handleClick: function() {
          this.props.onSelected(this.props.topic);
        },
        render: function() {
          var title = this.props.title;
          if (title.length > 30) {
            title = title.substring(0, 28) + "...";
          }
          var selected = (this.props.selected === this.props.topic) ? "selected" : null;
          var avatar = this.props.avatar ?
              <img src={this.props.avatar} className="avatar" /> :
              (Tinode.getTopicType(this.props.topic) === "grp") ?
                <i className="material-icons">group</i> :
                <i className="material-icons">person</i>;
          return (
            <li className={selected} onClick={this.handleClick}>
              <div className="avatar-box">
                {avatar}
                <span className={this.props.now ? "online" : "offline"}>&#x25cf;</span>
              </div>
              <div>
                <span className="contact-title">{title}</span> <Contact.Unread count={this.props.unread} />
                <p>{this.props.comment}</p>
              </div>
            </li>
          );
        }
    });

    /* The counter of unread messages in the topic */
    Contact.Unread = React.createClass({
        render: function() {
          var showUnreadBadge = null;
          if (this.props.count > 0) {
            var count = this.props.count > 9 ? "9+" : this.props.count;
            showUnreadBadge = <span className="badge">{count}</span>;
          }
          return (
            <span>{showUnreadBadge}</span>
          );
        }
    });

    /* ContactsView holds all contacts-related stuff */
    var ContactsView = React.createClass({
      getInitialState: function() {
        return {
          subscriptions: [],
          selected: null
        };
      },
      componentWillMount: function() {
        var me = Tinode.getMeTopic();
        me.onContactUpdate = this.tnMeContactUpdate;
        me.onData = this.tnInvite;
        me.onSubsUpdated = this.tnMeSubsUpdated;
      },
      tnMeContactUpdate: function(what, cont) {
        if (what === "on" || what === "off" || what === "read") {
          this.forceUpdate();
        } else if (what === "msg") {
          // Skip update if the topic is currently open, otherwise a badge will annoyingly pop up.
          if (this.state.selected !== cont.topic) {
            this.forceUpdate();
          }
        } else if (what === "recv") {
          // Explicitly ignoring "recv"
        } else {
          // TODO(gene): handle other types of notifications
          console.log("changed (not updating for it): " + what + " in:");
          console.log(cont);
        }
      },
      tnInvite: function(invite) {
        console.log(invite);
      },
      tnMeSubsUpdated: function(names) {
        this.forceUpdate();
      },
      onSelectionChange: function(sel) {
        this.setState({selected: sel});
        this.props.onTopicSelected(sel);
      },
      render: function() {
        var contactNodes = [];
        Tinode.getMeTopic().contacts(function(c) {
          var unread = c.seq;
          if (c.read > 0) {
            unread -= c.read;
          }
          contactNodes.push(
            <Contact
              title={c.public.fn}
              avatar={makeImageUrl(c.public.photo)}
              comment={c.private}
              unread={unread} now={c.online}
              selected={this.state.selected}
              onSelected={this.onSelectionChange}
              topic={c.topic}
              key={c.topic} />
          );
        }, this);

        return (
          <div id="contacts-panel">
            <ul id="contact-box">
              {contactNodes}
            </ul>
            <button className="round blue" id="add-topic" onClick={this.props.onNewTopic}>
              <i className="material-icons big">add</i>
            </button>
          </div>
        );
      }
    });
    /* END Contact list */

    /* BEGIN Conversation panel */
    var Received = {
      UNDEF: -2,
      SENDING: -1,
      SERVER: 0,
      CLIENT: 1,
      READ: 2
    };

    // Material colors, shade #200; 16 colors.
    var messageColors = [
      {bgColor: "#c5e1a5", color: "#212121"}, {bgColor: "#ef9a9a", color: "#212121"},
      {bgColor: "#90caf9", color: "#212121"}, {bgColor: "#fff59d", color: "#212121"},
      {bgColor: "#b0bec5", color: "#212121"}, {bgColor: "#f48fb1", color: "#212121"},
      {bgColor: "#b39ddb", color: "#212121"}, {bgColor: "#9fa8da", color: "#212121"},
      {bgColor: "#ffab91", color: "#212121"}, {bgColor: "#ffe082", color: "#212121"},
      {bgColor: "#a5d6a7", color: "#212121"}, {bgColor: "#bcaaa4", color: "#212121"},
      {bgColor: "#eeeeee", color: "#212121"}, {bgColor: "#80deea", color: "#212121"},
      {bgColor: "#e6ee9c", color: "#212121"}, {bgColor: "#ce93d8", color: "#212121"}
    ];
    // Colors for user's own messages
    var selfColor = {bgColor: "#fafafa", color: "#212121"};
    var Message = React.createClass({
      render: function() {
        var liClass = (this.props.response ? "left" : "right") + " " + this.props.sequence;
        var colors;
        colors = this.props.response ? {
            backgroundColor: messageColors[this.props.userIndex].bgColor,
            borderColor: messageColors[this.props.userIndex].bgColor,
            color: messageColors[this.props.userIndex].color
          } : {
            backgroundColor: selfColor.bgColor,
            borderColor: selfColor.bgColor,
            color: selfColor.color
          };
        var bubbleClass = (this.props.sequence === "single" || this.props.sequence === "last") ?
          "bubble tip" : "bubble";
        return (
          <li className={liClass}>
            <div className={bubbleClass} style={colors}>
              <p>{this.props.content}
              <Message.ReceivedMarker response={this.props.response}
                timestamp={this.props.timestamp} received={this.props.received} />
              </p>
            </div>
          </li>
        );
      }
    });

    /* Received/read indicator */
    Message.ReceivedMarker = React.createClass({
      render: function() {
        var timestamp = (this.props.received === Received.SENDING) ?
          "sending ..." :
          shortDateFormat(this.props.timestamp);
        var marker = null;

        if (this.props.received === Received.SENDING) {
          marker = (<i className="material-icons small">access_time</i>); // watch face
        } else if (this.props.received === Received.SERVER) {
          marker = (<i className="material-icons small">done</i>); // checkmark
        } else if (this.props.received === Received.CLIENT) {
          marker = (<i className="material-icons small">done_all</i>); // double checkmark
        } else if (this.props.received === Received.READ) {
          marker = (<i className="material-icons small blue">done_all</i>); // open eye
        }

        return (
          <span className="pull-right timestamp">
            {timestamp}{'\u00a0'}{marker}
          </span>
        );
      }
    });

    var MessagesView = React.createClass({
      getInitialState: function() {
        return {
          messages: [],
          topic: '',
          title: ''
        };
      },
      // Scroll last message into view on component update e.g. on message received.
      componentDidUpdate: function() {
        var node = this.refs.messagesPanel;
        if (node) {
          node.scrollTop = node.scrollHeight;
        }
      },
      componentWillMount: function() {
        this.propsChange(this.props);
      },
      componentWillReceiveProps: function(nextProps) {
        this.propsChange(nextProps);
      },
      propsChange: function(props) {
        if (props.topicSelected && (props.topicSelected != this.state.topic)) {
          var msgs = [];
          var topic = Tinode.getTopic(props.topicSelected);
          // Bind the new topic to component.
          topic.onData = this.handleNewMessage;
          topic.onInfo = this.handleInfoReceipt;
          topic.onMetaDesc = this.handleDescChange;
          topic.onSubsUpdated = this.handleSubsUpdated;
          // Unbind the previous topic from this component.
          if (this.state.topic) {
            var oldTopic = Tinode.getTopic(this.state.topic);
            oldTopic.onData = undefined;
            oldTopic.onInfo = undefined;
            oldTopic.onMetaDesc = undefined;
            oldTopic.onSubsUpdated = undefined;
          }

          if (topic.isSubscribed()) {
            this.handleDescChange(topic);
            topic.messages(function(msg) {
              msgs = msgs.concat(msg);
            });
          } else {
            topic.subscribe({get: {desc: {}, sub: {}, data: {}}});
          }

          // The user switched to the new topic before the timer for
          // the previous topic has triggered, kill it.
          clearTimeout(this.readTimer);

          this.setState({messages: msgs, topic: props.topicSelected});
        }
      },
      handleDescChange: function(desc) {
        this.setState({title: desc.public.fn});
      },
      handleSubsUpdated: function(uids) {

      },
      handleNewMessage: function(msg) {
        this.setState({messages: this.state.messages.concat(msg)});
        // Aknowledge all messages, including own messges.
        clearTimeout(this.readTimer);
        this.readTimer = setTimeout(function() {
          Tinode.getTopic(msg.topic).noteRead(msg.seq);
        }, READ_DELAY);
        this.props.onData(msg);
      },
      handleInfoReceipt: function(info) {
        switch (info.what) {
          case "kp":
            console.log("show typing notification");
            break;
          case "read":
          case "recv":
            // Redraw due to changed recv/read status.
            this.forceUpdate();
            break;
          default:
            console.log("other change in topic: " + info.what);
        }
      },
      render: function() {
        var component = null;
        if (this.state.topic) {
          var messageNodes = [];
          var myUid = Tinode.getCurrentUserID();
          var topic = Tinode.getTopic(this.state.topic);
          var previousFrom = null;
          for (var i=0; i<this.state.messages.length; i++) {
            var msg = this.state.messages[i];
            var nextFrom = (i + 1 < this.state.messages.length) ? this.state.messages[i+1].from : null;
            var sequence = "single";
            if (msg.from === previousFrom) {
              if (msg.from === nextFrom) {
                sequence = "middle";
              } else {
                sequence = "last";
              }
            } else if (msg.from === nextFrom) {
              sequence = "first";
            }
            previousFrom = msg.from;

            var isReply = !(msg.from === myUid);
            var msgReceived = Received.UNDEF;
            if (!isReply) {
              if (topic.msgReadCount(msg.seq) > 0) {
                msgReceived = Received.READ;
              } else if (topic.msgRecvCount(msg.seq) > 0) {
                msgReceived = Received.CLIENT;
              } else {
                msgReceived = Received.SERVER;
              }
            }
            messageNodes.push(
              <Message content={msg.content} timestamp={msg.ts} response={isReply}
                userIndex={msg.$userIndex} sequence={sequence} received={msgReceived} key={msg.seq} />
            );
          }

          var lastSeen = null;
          var cont = Tinode.getMeTopic().getContact(this.state.topic);
          if (cont && Tinode.getTopicType(cont.topic) === "p2p") {
            if (cont.online) {
              lastSeen = "online now";
            } else if (cont.seen) {
              lastSeen = "Last seen: " + shortDateFormat(cont.seen.when);
              // TODO(gene): also handle user agent in c.seen.ua
            }
          }

          component = (
            <div id="topic-view" className={this.props.hideSelf ? 'nodisplay' : null}>
              <div id="topic-caption-panel">
                {this.props.displayMobile ?
                  <a href="#" id="hide-message-view" onClick={this.props.onHideMessageView}>
                    <i className="material-icons big">arrow_back</i>
                  </a> :
                  null}
                <div id="topic-title-group">
                  <div id="topic-title" className="panel-title">{this.state.title}</div>
                  <div id="topic-last-seen">{lastSeen}</div>
                </div>
                <div id="topic-users">users online and menu buttons</div>
              </div>
              <div id="messages-panel" ref="messagesPanel">
                <ul className="chat-box">
                  {messageNodes}
                </ul>
              </div>
              <MessagesView.Send topic={this.props.topicSelected} sendMessage={this.props.sendMessage} />
            </div>
          );
        } else {
          component = (
            <MessagesView.Dummy hideSelf={this.props.hideSelf} />
          );
        }
        return component;
      }
    });

    /* Send message form */
    MessagesView.Send = React.createClass({
      getInitialState:function() {
        return {
          message: '',
          // Make initial keypress time as if it happened 5001 milliseconds in the past.
          keypressTimestamp: new Date().getTime() - KEYPRESS_DELAY - 1
        };
      },
      handleSend: function() {
        var message = this.state.message.trim();
        if (message) {
          this.props.sendMessage(this.state.message.trim());
          this.setState({message: ''});
        }
      },
      /* Send on Enter key */
      handleKeyPress: function(e) {
        /* Remove this if you don't want Enter to trigger send */
        if (e.key === 'Enter') {
          this.handleSend();
        }
      },
      handleMessageTyping: function(e) {
        var newState = {message: e.target.value};
        var now = new Date().getTime();
        if (now - this.state.keypressTimestamp > KEYPRESS_DELAY) {
          var topic = Tinode.getTopic(this.props.topic);
          if (topic.isSubscribed()) {
            topic.noteKeyPress();
          }
          newState.keypressTimestamp = now;
        }
        this.setState(newState);
      },
      render: function() {
        return (
          <div id="send-message-panel">
            <input id="sendMessage" type="text" placeholder="New message"
              value={this.state.message} onChange={this.handleMessageTyping} onKeyPress={this.handleKeyPress} />
            <a href="#" onClick={this.handleSend}>
              <i className="material-icons">send</i>
            </a>
          </div>
        );
      }
    });

    /* This is just a static page to display when no conversation is selected. */
    MessagesView.Dummy = React.createClass({
      render: function() {
        var version = document.lastModified;
        return (
          <div id="dummy-view" className={this.props.hideSelf ? 'nodisplay' : null}>
            <a href="https://github.com/tinode/chat/">
              <img id="logo" alt="logo" src="img/logo.svg" />
              <h2>Tinode Demo Chat</h2>
              <p>Version: {version}</p>
            </a>
          </div>
        );
      }
    });
    /* END Conversation panel */

    /* This is a div which covers the entire AppView and shows selected modal dialog box */
    var ModalDialogWrapper = React.createClass({
      render: function() {
        var dialog = null;
        switch (this.props.dialog) {
          case "new-topic":
            dialog = <ModalDialogWrapper.NewTopic
              onOk={this.props.onOk}
              onCancel={this.props.onCancel} />;
            break;
          default:
            break;
        }
        if (dialog) {
          dialog = <div className="dialog-overlay">{dialog}</div>;
        }
        return dialog;
      }
    });

    ModalDialogWrapper.NewTopic = React.createClass({
      render: function() {
        return (
          <div className="modal-dialog">
            <div className="title-panel">
              New topic
            </div>
            <div className="body-panel">Not implemented</div>
            <div className="dialog-buttons">
              <a href="#" onClick={this.props.onOk}>Yes</a>
              <a href="#" onClick={this.props.onCancel}>OK</a>
            </div>
          </div>
        );
      }
    });
    /* End of modal dialog wrapper */

    /* The top-level class to hold all fuinctionality together */
    var AppView = React.createClass({
      getInitialState: function() {
        return {
          sidePanelSelected: 'login',
          sidePanelTitle: null,
          sidePanelAvatar: null,
          dialogSelected: null,
          loggedIn: false,
          errorText: '',
          topicSelected: '',
          loginDisabled: false,
          subscriptions: {},
          displayMobile: (window.innerWidth <= MEDIA_BREAKPOINT),
          mobilePanel: 'sidepanel'
        };
      },
      componentDidMount: function() {
        window.addEventListener('resize', this.handleResize);
        Tinode.enableLogging(true);
        Tinode.onDisconnect = this.handleDisconnect;
        // Setup with the default transport, usually websocket.
        Tinode.setup(APP_NAME, HOST, API_KEY);
      },
      componentWillUnmount: function(){
        window.removeEventListener('resize', this.handleResize);
      },
      handleResize: function(){
        var mobile = document.documentElement.clientWidth <= MEDIA_BREAKPOINT;
        if (this.state.displayMobile != mobile) {
          this.setState({displayMobile: mobile});
        }
      },
      handleDisconnect: function() {
        this.setState({
          sidePanelSelected: 'login',
          sidePanelTitle: null,
          sidePanelAvatar: null,
          dialogSelected: null,
          loggedIn: false,
          errorText: 'disconnected',
          topicSelected: '',
          loginDisabled: false,
          subscriptions: {},
          mobilePanel: 'sidepanel'
        });
      },
      // User clicked Login button in the side panel.
      handleLoginRequest: function(login, password) {
        var instance = this;
        this.setState({loginDisabled: true, errorText: ''});
        Tinode.connect().then(function() {
          // Login
          return Tinode.loginBasic(login, password);
        }).then(function() {
          // Logged in fine, subscribe to 'me' attaching callbacks from the contacts view.
          var me = Tinode.getMeTopic();
          me.onMetaDesc = instance.tnMeMetaDesc;
          instance.setState({sidePanelSelected: "contacts", loggedIn: true});
          // Subscribe, fetch topic desc, the list of subscriptions, and messages (invites).
          me.subscribe({get: {desc: {}, sub: {}, data: {}}});
        }).catch(function(err) {
          // Login failed, report error
          instance.setState({loginDisabled: false, errorText: err.message});
        });
      },
      tnMeMetaDesc: function(desc) {
        this.setState({
          sidePanelTitle: desc.public.fn,
          sidePanelAvatar: makeImageUrl(desc.public.photo)
        });
      },
      // Sending "received" notifications
      tnData: function(data) {
        clearTimeout(this.receivedTimer);
        this.receivedTimer = setTimeout(function() {
          this.receivedTimer = undefined;
          Tinode.getTopic(data.topic).noteRecv(data.seq);
        }, RECEIVED_DELAY);
      },
      // Registration of a new account.
      handleNewAccount: function(login_, password_, public_, private_) {
        var instance = this;
        Tinode.connect().then(function() {
          return Tinode.createUserBasic(login_, password_,
            {login: "basic", public: public_, private: private_});
        }).catch(function(err) {
          instance.setState({errorText: err.message});
        });
      },
      // User clicked on a contact in the side panel.
      handleTopicSelected: function(topicName) {
        this.setState({topicSelected: topicName, mobilePanel: 'topic-view'});
      },
      // In mobile view user requested to show sidepanel
      handleHideMessageView: function() {
        this.setState({mobilePanel: 'sidepanel'});
      },
      // User clicked on a message send button.
      handleSendMessage: function(msg) {
        var topic = Tinode.getTopic(this.state.topicSelected);
        topic.publish(msg);
      },
      // User chose a Sign Up menu item.
      handleSignUp: function() {
        this.setState({sidePanelSelected: 'register'});
      },
      // User chose Settings menu item.
      handleSettings: function() {
        this.setState({sidePanelSelected: this.state.loggedIn ? 'edit-account' : 'settings'});
      },
      // User clicked Cancel button in Setting or Sign Up panel.
      handleSidepanelCancel: function() {
        if (this.state.loggedIn) {
          this.setState({sidePanelSelected: 'contacts'});
        } else {
          this.setState({sidePanelSelected: 'login'});
        }
      },
      handleNewTopic: function() {
        this.setState({dialogSelected: 'new-topic'});
      },
      handleDialogCancel: function() {
        this.setState({dialogSelected: null});
      },
      render: function() {
        return (
          <div id="app-container">
            <ModalDialogWrapper
              dialog={this.state.dialogSelected}
              onOk={this.handleDialogCancel}
              onCancel={this.handleDialogCancel} />

            <SidepanelView
              displayMobile={this.state.displayMobile}
              hideSelf={(this.state.displayMobile && this.state.mobilePanel !== 'sidepanel')}
              state={this.state.sidePanelSelected}
              title={this.state.sidePanelTitle}
              avatar={this.state.sidePanelAvatar}
              subscriptions={this.state.subscriptions}
              loginDisabled={this.state.loginDisabled}
              errorText={this.state.errorText}
              onSignUp={this.handleSignUp}
              onSettings={this.handleSettings}
              onLoginRequest={this.handleLoginRequest}
              onCreateAccount={this.handleNewAccount}
              onTopicSelected={this.handleTopicSelected}
              onNewTopic={this.handleNewTopic}
              onCancel={this.handleSidepanelCancel} />

            <MessagesView
              onHideMessageView={this.handleHideMessageView}
              displayMobile={this.state.displayMobile}
              hideSelf={(this.state.displayMobile && this.state.mobilePanel !== 'topic-view')}
              topicSelected={this.state.topicSelected}
              onData={this.tnData}
              sendMessage={this.handleSendMessage} />

          </div>
        );
      }
    })

    ReactDOM.render(
      <AppView />,
      document.getElementById('mountPoint')
    );
    </script>
  </body>
</html>
